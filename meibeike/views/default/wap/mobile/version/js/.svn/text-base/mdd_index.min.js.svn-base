(function(b) {
	var e = {
		init: function() {
			this.landingInit();
			this.seckillInit();
			this.suggestInit();
			this.browserDetectiveInit();
			this.appDownloadInit();
			this.lazyLoadInit()
		},
		isInViewport: function(a) {
			if(!a || 1 !== a.nodeType) return !1;
			a = a.getBoundingClientRect();
			return 0 > a.bottom ? !1 : a.top < Math.max(window.innerHeight, document.documentElement.clientHeight)
		},
		images: function(a) {
			var b = new Image,
				g = a.attr("imgsrc");
			b.onload = function() {
				1 == b.complete && (a.attr("src", g), a.removeClass("lazy"), a.removeAttr("imgsrc"))
			};
			b.src = g
		},
		browserDetectiveInit: function() {
			var a = navigator.userAgent;
			this.browser = {
				versions: {
					trident: -1 < a.indexOf("Trident"),
					presto: -1 < a.indexOf("Presto"),
					webKit: -1 < a.indexOf("AppleWebKit"),
					gecko: -1 < a.indexOf("Gecko") && -1 == a.indexOf("KHTML"),
					mobile: !!a.match(/AppleWebKit.*Mobile.*/),
					ios: !!a.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),
					android: -1 < a.indexOf("Android") || -1 < a.indexOf("Linux"),
					iPhone: -1 < a.indexOf("iPhone"),
					iPad: -1 < a.indexOf("iPad"),
					webApp: -1 == a.indexOf("Safari"),
					uc: !!a.match(/UCBrowser/)
				},
				language: (navigator.browserLanguage || navigator.language).toLowerCase()
			}
		},
		landingInit: function() {
			b(".landing").on("touchmove", function(a) {
				0 < b(a.target).parents("#landing").length && a.preventDefault()
			}, !1)
		},
		appDownloadInit: function() {
			var a = this;
			b(".landing .top span").on("click", function() {
				a.appDownload(window.landingUrlConfig)
			});
			b(".landing-app-download").on("click", function() {
				a.appDownload(window.landingAppUrlConfig)
			});
			b("#closeLanding").on("click", function() {
				b(".landing").remove();
				a.tempClose("landing")
			});
			b(".close-app-download").on("click", function() {
				b(this).parent().remove();
				a.tempClose(b(this).parent().data("pos"))
			})
		},
		openApp: function(a, b) {
			var g = Date.now(),
				c = document.createElement("IFRAME");
			c.src = a;
			c.style.position = "absolute";
			c.style.left = "-1000px";
			c.style.top = "-1000px";
			c.style.width = "1px";
			c.style.height = "1px";
			c.style.webkitTransition = "all 2s";
			document.body.appendChild(c);
			setTimeout(function() {
				c.addEventListener("webkitTransitionEnd", function() {
					document.body.removeChild(c);
					3E3 > Date.now() - g && "function" === typeof b && b()
				}, !1);
				c.style.left = "-10px"
			}, 0)
		},
		appDownload: function(a) {
			var b = this;
			!a.app_url && (a.app_url = "dangdang://");
			this.openApp(a.app_url, function() {
				b.browser.versions.android ? location.href = a.android_url : b.browser.versions.ios && (location.href = a.iphone_url)
			})
		},
		slideInit: function(a) {
			var b = this;
			a.on("scrollStart", function() {
				window.clearInterval(a.timer);
				a.timer = setInterval(function() {
					a.directionX = 1;
					b.slidePic(a)
				}, 5E3)
			});
			a.on("scrollEnd", function() {
				b.slidePic(this)
			});
			b.slideRun(a)
		},
		slidePic: function(a) {
			0 != a.directionX && (a.pageNum += a.directionX, a.pageNum >= a.pageSize ? a.pageNum = 0 : 0 > a.pageNum && (a.pageNum = a.pageSize - 1), a.scrollToElement(b(a.scroller).find("li").eq(a.pageNum)[0], 300), b(a.wrapper).find(".on").removeClass("on"), b(a.wrapper).find(".dot").eq(a.pageNum).addClass("on"), a.directionX = 0)
		},
		slideRun: function(a) {
			var b = this;
			a.timer = setInterval(function() {
				a.directionX = 1;
				b.slidePic(a)
			}, 5E3)
		},
		topSliderInit: function() {
			if(0 < b(".J_top_slider").length) {
				var a = new IScroll(".J_top_slider", {
					scrollX: !0,
					scrollY: !1,
					snap: !1,
					momentum: !1,
					click: !1,
					eventPassthrough: !0,
					preventDefault: !0
				});
				a.pageNum = 0;
				a.pageSize = b(".J_top_slider li").length;
				this.slideInit(a)
			}
		},
		bannerSliderInit: function() {
			var a = this;
			b(".J_banner_slider").each(function() {
				var d = b(this)[0].id,
					d = new IScroll("#" + d, {
						scrollX: !0,
						scrollY: !1,
						snap: !1,
						momentum: !1,
						click: !1,
						eventPassthrough: !0,
						preventDefault: !0
					});
				d.pageNum = 0;
				d.pageSize = b(this).find("li").length;
				a.slideInit(d)
			})
		},
		suggestInit: function() {
			this.suggest = new Suggest({
				ajaxUrl: index_url + "h5ajax.php",
				defaultVal: b("#keyword").attr("placeholder"),
				formEl: "#index_search_form",
				wrapEl: ".search_list"
			})
		},
		seckillInit: function() {
			this.seckill = (new Countdown({
				target: "[data-widget\x3d'countdown']",
				endTime: b("[data-widget\x3d'countdown']").data("end-time"),
				leftTime: b("[data-widget\x3d'countdown']").data("left-time"),
				el_hour: "[data-countdown-role\x3d'hour']",
				el_min: "[data-countdown-role\x3d'min']",
				el_sec: "[data-countdown-role\x3d'sec']",
				speed: 1
			})).start()
		},
		lazyLoadInit: function() {
			window.rec_last_page = 0;
			var a = this;
			b(".lazy").each(function() {
				a.isInViewport(this) && a.images(b(this))
			});
			window.onscroll = function() {
				e.goTop();
				b(".lazy").each(function() {
					a.images(b(this))
				});
				0 == b(".rec-prds").length && 1 != b(".rec-prds-wrapper").data("lazyLoad") && b(window).scrollTop() + window.innerHeight > b(".rec-prds-wrapper").offset().top - 150 && (b(".rec-prds-wrapper").data("lazyLoad", !0), a.recPrdsInit())
			}
		},
		recPrdsInit: function() {
			this.recPrdsWrapperTpl = '\x3ch2 class\x3d"title"\x3e\u63a8\u5e7f\u5546\u54c1\x3c/h2\x3e\x3cdiv class\x3d"rec-prds"\x3e\x3cul\x3e\x3c/ul\x3e\x3c/div\x3e';
			this.recPrdsTpl = ['\x3cli data-page-nubmer\x3d"\x3c%\x3d pageNum %\x3e" \x3e\n\x3ca href\x3d"\x3c%\x3d callback_url %\x3e"\x3e', '\x3cimg class\x3d"lazy" src\x3d"' + window.proxyAssets + '/coreimages/bg_pic.png" imgsrc\x3d"\x3c%\x3d image_url %\x3e" alt\x3d""\x3e', '\x3cdiv class\x3d"rec-prds-detail"\x3e\n\x3cp class\x3d"rec-prds-name"\x3e\x3c%\x3d name%\x3e\x3c/p\x3e\n\x3cp class\x3d"price"\x3e\n    \x3cspan class\x3d"rob"\x3e\n        \x3cspan class\x3d"sign"\x3e\x26yen;\x3c/span\x3e\n        \x3cspan class\x3d"num"\x3e\x3c%\x3dprice%\x3e\x3c/span\x3e\n        \x3cspan class\x3d"tail"\x3e\x3c/span\x3e\n    \x3c/span\x3e\n\x3c/p\x3e\n\x3c/div\x3e\n\x3c/a\x3e\n\x3c/li\x3e'].join("\n");
			var a = this,
				d = b("html").css("font-size").replace("px", "");
			window.rec_prds = {
				pageSize: 4,
				currentPageNum: 1,
				maxPageNum: 1,
				liWidth: 5.25 * d,
				pageWidth: 21 * d
			};
			window.recUnlock = !0;
			this.loadRecPrds(1, window.rec_prds.pageSize);
			setTimeout(function() {
				a.loadRecPrds(2, window.rec_prds.pageSize)
			}, 300)
		},
		recPrdsScroller: function() {
			var a = this;
			window.rec_prds_scroller = new IScroll(".rec-prds", {
				scrollX: !0,
				scrollY: !1,
				snap: !1,
				momentum: !0,
				deceleration: .005,
				click: !1,
				eventPassthrough: !0,
				preventDefault: !0,
				useTransition: !1,
				disableMouse: !0,
				disablePointer: !0
			});
			rec_prds_scroller.on("scrollEnd", function() {
				rec_prds.currentPage = Math.ceil(this.x / -rec_prds.pageWidth) + 1;
				this.x > this.startX ? (1 == b('.rec-prds li[data-page-nubmer\x3d"' + rec_prds.currentPage + '"]').data("destroyed") && a.loadRecPrds(rec_prds.currentPage, rec_prds.pageSize, "destroyed"), 1 != rec_prds.currentPage && 0 == b('[data-page-nubmer\x3d"' + (rec_prds.currentPage - 1) + '"]').length && a.loadRecPrds(rec_prds.currentPage - 1, rec_prds.pageSize, "destroyed"), 1 == b('.rec-prds li[data-page-nubmer\x3d"' + (rec_prds.currentPage - 1) + '"]').data("destroyed") && a.loadRecPrds(rec_prds.currentPage - 1, rec_prds.pageSize, "destroyed"), 1 == b('.rec-prds li[data-page-nubmer\x3d"' + (rec_prds.currentPage - 2) + '"]').data("destroyed") && a.loadRecPrds(rec_prds.currentPage - 2, rec_prds.pageSize, "destroyed"), 1 == b('.rec-prds li[data-page-nubmer\x3d"' + (rec_prds.currentPage - 3) + '"]').data("destroyed") && a.loadRecPrds(rec_prds.currentPage - 3, rec_prds.pageSize, "destroyed")) : (0 == b('[data-page-nubmer\x3d"' + (rec_prds.currentPage + 1) + '"]').length && a.moreRecPrds(rec_prds.currentPage + 1, rec_prds.pageSize), 1 == b('.rec-prds li[data-page-nubmer\x3d"' + rec_prds.currentPage + '"]').data("destroyed") && a.loadRecPrds(rec_prds.currentPage, rec_prds.pageSize, "destroyed"), 1 != rec_prds.currentPage && 0 == b('[data-page-nubmer\x3d"' + (rec_prds.currentPage - 1) + '"]').length && a.loadRecPrds(rec_prds.currentPage - 1, rec_prds.pageSize, "insert"), b('[data-page-nubmer\x3d"' + (rec_prds.currentPage - 4) + '"]').html("").data("destroyed", !0), 1 == b('.rec-prds li[data-page-nubmer\x3d"' + rec_prds.currentPage + '"]').data("destroyed") && a.loadRecPrds(rec_prds.currentPage, rec_prds.pageSize, "destroyed"))
			})
		},
		loadRecPrds: function(a, d, g) {
			var c = this,
				e = "";
			window.recUnlock && (window.recUnlock = !1, b.ajax({
				type: "POST",
				url: index_url + "h5ajax.php",
				data: {
					action: "ad_cpc",
					page: a,
					pagesize: d,
					lastpage: window.rec_last_page
				},
				dataType: "json",
				success: function(f) {
					if(0 == f.errorCode) {
						window.rec_last_page = f.lastpage || window.rec_last_page;
						0 == b(".rec-prds").length && 0 < f.products.length && b(".rec-prds-wrapper").html(c.recPrdsWrapperTpl);
						if(1 < a && f.products.length < d) {
							window.recUnlock = !0;
							return
						}
						_.each(f.products, function(b, d, f) {
							b.pageNum = a;
							e += _.template(c.recPrdsTpl)(b)
						});
						g ? "destroyed" == g ? (f = b(".rec-prds ul").find("[data-page-nubmer\x3d'" + a + "']"), f.not(f.eq(0)).remove(), f = b(".rec-prds ul").find("[data-page-nubmer\x3d'" + a + "']"), f.replaceWith(e)) : "insert" == g && (f = b(".rec-prds ul").find("[data-page-nubmer\x3d'" + (a + 1) + "']"), b(e).insertBefore(f.eq(0))) : (b(".rec-prds ul").width(parseFloat(b(".rec-prds ul").css("width").replace("px", "")) + window.rec_prds.pageWidth), b(".rec-prds ul").append(e), setTimeout(function() {
							window.rec_prds_scroller.refresh()
						}, 200), b(".rec-prds ul li").length == d && c.recPrdsScroller());
						b(".lazy").each(function() {
							c.images(b(this))
						})
					}
					window.recUnlock = !0
				},
				error: function(a, b, d) {
					console.log(d);
					window.recUnlock = !0
				}
			}))
		},
		moreRecPrds: function(a, b) {
			this.loadRecPrds(a, b)
		},
		tempClose: function(a) {
			var b = new Date;
			b.setDate(b.getDate() + 1);
			b.setHours(0);
			b.setMinutes(0);
			b.setSeconds(0);
			str = "MDD_temp_close_" + a + "\x3d1; expires\x3d" + b.toGMTString();
			document.cookie = str
		},
//		fontSizeInit: function() {
//			var a = document.documentElement,
//				b = a.clientWidth;
//			b && (b /= 320, 2 < b && (b = 2), a.style.fontSize = 20 * b + "px")
//		},
		goTop: function() {
			var a = document.body.scrollTop || document.documentElement.scrollTop,
				d = b(window).height(),
				e = b(".fixed_box"),
				c = b(".top")[0];
			a > d ? e.show() : e.hide();
			this.isInViewport(c) && e.hide()
		}
	};
	b(document).ready(function() {
		e.fontSizeInit();
		FastClick.attach(document.body);
		e.init();
		window.submit_search = function() {
			"" == b("#keyword").val() && b("#keyword").val(b("#keyword").attr("placeholder"));
			return !0
		}
	});
	window.onresize = function() {
		e.fontSizeInit()
	};
	window.onload = function() {
		e.topSliderInit();
		e.bannerSliderInit()
	}
})(Zepto);